<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Controle - Projeto Executivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Config
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('debug');

        let userId = null;
        let projectDataUnsubscribe = null;
        const projectDocId = "executiveSummary"; 
        let projectDocRef;

        // Options for select dropdowns
        const taskStatusOptions = ["Não Iniciado", "Em Planejamento", "Em Andamento", "Concluído", "Atrasado", "Em Risco", "Pendente"];
        const taskCriticalityOptions = ["Baixa", "Média", "Alta", "Crítico", "Em avaliação"];
        const itemStatusOptions = ["Aberto", "Em Andamento", "Resolvido", "Mitigado", "Fechado", "Monitorando"];
        const trafficLightColorOptions = { 
            "none": "Nenhum", "green": "Baixo", "yellow": "Médio", "red": "Crítico"
        };
        const activityOptions = ["Não iniciada", "Análise de impacto", "Refinamento", "Desenvolvimento", "Testes", "Homologação"];
        const activityOrder = { 
            "Homologação": 5, "Testes": 4, "Desenvolvimento": 3, "Refinamento": 2, "Análise de impacto": 1, "Não iniciada": 0
        };
        
        let domReady = false; 

        const initialProjectData = {
            projectName: "Projeto Estratégico Exemplo", 
            projectResponsibles: "Nome do Gerente (Gerente), Nome do Técnico (Técnico)",
            projectDepartment: "Departamento Exemplo",
            projectTerm: `${new Date().toLocaleDateString('pt-BR')} - ${new Date(new Date().setFullYear(new Date().getFullYear() + 1)).toLocaleDateString('pt-BR')}`, // Default to 1 year
            objective: "Assegurar que a suspensão dos planos pela ANS não impeça a adesão de novos beneficiários aos produtos e planos temporariamente indisponíveis, evitando multas e impacto comercial.",
            mainImpactsAndRisksHTML: `<ul class="list-disc list-inside text-sm text-gray-600 space-y-1"><li>Impacto/Risco Exemplo 1.</li><li>Impacto/Risco Exemplo 2.</li></ul>`,
            projectDetailsHTML: `<div class="text-sm text-gray-600"><p>Detalhes adicionais do projeto podem ser inseridos aqui.</p></div>`,
            currentPhase: "Planejamento",
            nextMilestoneText: "Definição do Escopo (dd/mm/aaaa)",
            progress: 0,
            risks: [],    
            problems: [], 
            impacts: [],  
            tasks: [] 
        };
        let currentProjectData = { ...initialProjectData };

        onAuthStateChanged(auth, async (user) => {
            const userIdElement = document.getElementById('userIdDisplay');
            if (user) {
                userId = user.uid;
                if (userIdElement) userIdElement.textContent = userId;
                projectDocRef = doc(db, `artifacts/${appId}/public/data/projectManagerExecutive/${projectDocId}`);
                if (domReady) { loadProjectData(); }
            } else {
                userId = null; projectDocRef = null;
                if (userIdElement) userIdElement.textContent = "Autenticando...";
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else { await signInAnonymously(auth); }
                } catch (error) {
                    console.error("Error during sign-in:", error);
                    if (userIdElement) userIdElement.textContent = "Falha na autenticação";
                    displayMessage("Erro de autenticação.", "error");
                }
                if (domReady) { updateUI(initialProjectData); }
            }
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            domReady = true; 
            attachActionListeners(); 

            const currentYearEl = document.getElementById('currentYear');
            if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();
            
            const lastUpdatedEl = document.getElementById('lastUpdatedDate');
            if(lastUpdatedEl) lastUpdatedEl.textContent = new Date().toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });

            const userIdElement = document.getElementById('userIdDisplay');
            if(userId && userIdElement) userIdElement.textContent = userId;

            if (userId && projectDocRef) { loadProjectData(); } 
            else { updateUI(initialProjectData); }
        });

        async function loadProjectData() {
            if (!domReady || !userId || !projectDocRef) {
                updateUI(initialProjectData); return;
            }
            if (projectDataUnsubscribe) projectDataUnsubscribe();
            projectDataUnsubscribe = onSnapshot(projectDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    currentProjectData = { ...initialProjectData, ...docSnap.data() };
                    updateUI(currentProjectData);
                } else {
                    currentProjectData = { ...initialProjectData }; 
                    setDoc(projectDocRef, currentProjectData)
                        .then(() => updateUI(currentProjectData))
                        .catch(error => {
                            console.error("Error initializing project data by setDoc:", error);
                            updateUI(currentProjectData); 
                        });
                }
            }, error => {
                console.error("Error listening to project data:", error);
                updateUI(currentProjectData); 
            });
        }

        async function saveProjectDataField(field, value) {
            if (!projectDocRef) { displayMessage("Conexão de dados não estabelecida.", "error"); return; }
            try { await updateDoc(projectDocRef, { [field]: value }); } 
            catch (error) { displayMessage(`Erro ao salvar ${field}.`, "error"); }
        }
        
        async function addNewTaskToSchedule() { 
            if (!projectDocRef) { displayMessage("Ação indisponível. Dados do projeto não carregados.", "error"); return; }
            const newTask = {
                id: crypto.randomUUID(), processo: "Novo Processo", squad: "Nova Squad", 
                activity: "Não iniciada", 
                startDate: new Date().toISOString().split('T')[0], endDate: "", duration: 0,
                productLead: "", deliveryLead: "", technicalLead: "",
                criticality: "Média", status: "Não Iniciado", progress: 0
            };
            try {
                await updateDoc(projectDocRef, { tasks: arrayUnion(newTask) });
                displayMessage("Nova tarefa adicionada.", "success");
            } catch (error) { console.error("Error adding task:", error); displayMessage("Erro ao adicionar tarefa.", "error"); }
        }

        async function updateTaskInSchedule(taskId, field, value) { 
             if (!projectDocRef) { displayMessage("Ação indisponível. Dados do projeto não carregados.", "error"); return; }
            const taskIndex = currentProjectData.tasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            const updatedTasks = [...currentProjectData.tasks];
            const taskToUpdate = { ...updatedTasks[taskIndex] };

            if (field === 'responsibles') { 
                const parts = value.split(';');
                taskToUpdate.productLead = parts[0]?.replace('P:', '').trim() || '';
                taskToUpdate.deliveryLead = parts[1]?.replace('E:', '').trim() || '';
                taskToUpdate.technicalLead = parts[2]?.replace('T:', '').trim() || '';
            } else { taskToUpdate[field] = value; }

            if ((field === 'startDate' || field === 'endDate') && taskToUpdate.startDate && taskToUpdate.endDate) {
                const start = new Date(taskToUpdate.startDate); const end = new Date(taskToUpdate.endDate);
                if (end >= start) { taskToUpdate.duration = Math.ceil(Math.abs(end - start) / (1000*60*60*24)) + 1; } else { taskToUpdate.duration = 0; }
            }
             if (field === 'status' && value === 'Concluído') { taskToUpdate.progress = 100; }
            else if (field === 'progress') {
                 taskToUpdate.progress = Math.max(0, Math.min(100, Number(value) || 0));
                 if (taskToUpdate.progress === 100 && taskToUpdate.status !== 'Concluído') { taskToUpdate.status = 'Concluído'; }
                 else if (taskToUpdate.progress < 100 && taskToUpdate.status === 'Concluído') { taskToUpdate.status = 'Em Andamento'; }
            }
            updatedTasks[taskIndex] = taskToUpdate;
            try { 
                await updateDoc(projectDocRef, { tasks: updatedTasks });
                calculateOverallProjectProgress(updatedTasks);
                 renderTimeline(updatedTasks); // Re-render timeline if a task status changes
            }
            catch (error) { console.error("Error updating task:", error); displayMessage("Erro ao atualizar tarefa.", "error"); }
        }
        async function removeTaskFromSchedule(taskId) { 
            if (!projectDocRef) { displayMessage("Ação indisponível. Dados do projeto não carregados.", "error"); return; }
            const taskToRemove = currentProjectData.tasks.find(t => t.id === taskId);
            if (!taskToRemove) return;
            try { 
                await updateDoc(projectDocRef, { tasks: arrayRemove(taskToRemove) }); 
                displayMessage("Tarefa removida.", "success");
                renderTimeline(currentProjectData.tasks.filter(t => t.id !== taskId)); // Re-render timeline
            }
            catch (error) { console.error("Error removing task:", error); displayMessage("Erro ao remover tarefa.", "error"); }
        }
        async function deleteAllTasksFromSchedule() { 
            if(!projectDocRef) { displayMessage("Ação indisponível. Dados do projeto não carregados.", "error"); return;}
            const modal = document.getElementById('confirmationModal');
            const textEl = document.getElementById('confirmationModalText');
            const confirmBtn = document.getElementById('confirmDeleteAllTasksBtn');
            const cancelBtn = document.getElementById('cancelDeleteAllTasksBtn');
            if(modal && textEl && confirmBtn && cancelBtn) {
                textEl.textContent = "Tem certeza que deseja excluir TODAS as tarefas do cronograma?";
                modal.classList.remove('hidden');
                confirmBtn.onclick = async () => {
                    try { 
                        await updateDoc(projectDocRef, { tasks: [] }); 
                        displayMessage("Todas tarefas excluídas.", "success"); 
                        renderTimeline([]); // Clear timeline
                    }
                    catch (error) { console.error("Error deleting all tasks:", error); displayMessage("Erro ao excluir tarefas.", "error"); }
                    modal.classList.add('hidden');
                };
                cancelBtn.onclick = () => modal.classList.add('hidden');
            } else { console.error("Confirmation modal elements not found for deleteAllTasks.");}
        }

        async function addItemToList(listName, itemDescription) {
            if (!projectDocRef) { displayMessage("Ação indisponível. Dados não carregados.", "error"); return; }
            if (!itemDescription.trim()) { displayMessage("Por favor, insira uma descrição.", "info"); return;}
            const newItem = { 
                id: crypto.randomUUID(), 
                description: itemDescription.trim(),
                status: "Aberto",
                plannedPercentage: 0,
                actualPercentage: 0,
                endDate: "",
                trafficLight: "none", 
                deviationReason: ""
            };
            try {
                await updateDoc(projectDocRef, { [listName]: arrayUnion(newItem) });
                 displayMessage(`${itemSingular(listName)} adicionado(a).`, "success"); 
            } catch (error) {
                 displayMessage(`Erro ao adicionar ${itemSingular(listName)}.`, "error");
            }
        }

        async function updateListItemField(listName, itemId, field, value) {
            if (!projectDocRef) { displayMessage("Ação indisponível. Dados não carregados.", "error"); return; }
            const list = currentProjectData[listName] || [];
            const itemIndex = list.findIndex(item => item.id === itemId);
            if (itemIndex === -1) { console.warn(`Item ${itemId} not found in ${listName}`); return;}

            const updatedList = [...list];
            updatedList[itemIndex] = { ...updatedList[itemIndex], [field]: value };
            
            try {
                await updateDoc(projectDocRef, { [listName]: updatedList });
            } catch (error) {
                console.error(`Error updating item in ${listName}:`, error);
                displayMessage(`Erro ao atualizar ${itemSingular(listName)}.`, "error");
            }
        }

        async function removeItemFromList(listName, itemId) { 
            if (!projectDocRef) { displayMessage("Ação indisponível. Dados do projeto não carregados.", "error"); return; }
            const list = currentProjectData[listName] || [];
            const itemToRemove = list.find(item => item.id === itemId);
            if (!itemToRemove) return;
            try {
                await updateDoc(projectDocRef, { [listName]: arrayRemove(itemToRemove) });
                displayMessage(`${itemSingular(listName)} removido(a).`, "success");
            } catch (error) {
                console.error(`Error removing item from ${listName}:`, error);
                displayMessage(`Erro ao remover ${itemSingular(listName)}.`, "error");
            }
        }
        function itemSingular(listName) { 
            if (listName === 'risks') return 'Risco';
            if (listName === 'problems') return 'Problema';
            if (listName === 'impacts') return 'Impacto';
            return 'Item';
        }

        async function callGeminiAPI(prompt) { /* ... (same as before) ... */ }
        async function suggestItemsWithAI(listType) { /* ... (same as before) ... */ }
        async function detailTaskWithAI(task) { /* ... (same as before) ... */ }
        async function analyzeDeadlinesWithAI() { /* ... (same as before) ... */ }


        function updateUI(data) {
            if (!domReady) { console.warn("updateUI called before DOM ready."); return; }

            const projectTitleHeaderEl = document.getElementById('projectTitleHeader');
            if (projectTitleHeaderEl) projectTitleHeaderEl.textContent = data.projectName || initialProjectData.projectName;
            
            const projectResponsiblesEl = document.getElementById('projectResponsibles');
            if(projectResponsiblesEl) projectResponsiblesEl.textContent = data.projectResponsibles || initialProjectData.projectResponsibles;
            
            const projectDepartmentEl = document.getElementById('projectDepartment');
            if(projectDepartmentEl) projectDepartmentEl.textContent = data.projectDepartment || initialProjectData.projectDepartment;

            const projectTermEl = document.getElementById('projectTerm');
            if(projectTermEl) projectTermEl.textContent = data.projectTerm || initialProjectData.projectTerm;

            const projectObjectiveEl = document.getElementById('projectObjectiveTextarea');
            if (projectObjectiveEl) projectObjectiveEl.value = data.objective || initialProjectData.objective ||'';

            const mainImpactsRisksEl = document.getElementById('mainImpactsAndRisksContent');
            if(mainImpactsRisksEl) mainImpactsRisksEl.innerHTML = data.mainImpactsAndRisksHTML || initialProjectData.mainImpactsAndRisksHTML;

            const projectDetailsEl = document.getElementById('projectDetailsContent');
            if(projectDetailsEl) projectDetailsEl.innerHTML = data.projectDetailsHTML || initialProjectData.projectDetailsHTML;
            
            const currentPhaseEl = document.getElementById('currentPhase');
            if(currentPhaseEl) currentPhaseEl.textContent = data.currentPhase || initialProjectData.currentPhase;

            const nextMilestoneEl = document.getElementById('nextMilestoneText');
            if(nextMilestoneEl) nextMilestoneEl.textContent = data.nextMilestoneText || initialProjectData.nextMilestoneText;

            const sortedTasks = (data.tasks || []).sort((a, b) => {
                const orderA = activityOrder[a.activity] ?? -1; 
                const orderB = activityOrder[b.activity] ?? -1;
                return orderB - orderA; 
            });
            renderDetailedSchedule(sortedTasks);
            renderTimeline(sortedTasks); // Render timeline with sorted (all) tasks

            calculateOverallProjectProgress(data.tasks || []);

            renderList('risksContainer', data.risks || [], 'risks', 'Risco');
            renderList('problemsContainer', data.problems || [], 'problems', 'Problema');
            renderList('impactsContainer', data.impacts || [], 'impacts', 'Impacto');
        }

        function calculateOverallProjectProgress(tasks) {
            let totalProgress = 0; let tasksWithProgress = 0;
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    const progress = Number(task.progress);
                    if (!isNaN(progress)) { totalProgress += progress; tasksWithProgress++; }
                });
                currentProjectData.progress = tasksWithProgress > 0 ? Math.round(totalProgress / tasksWithProgress) : 0; 
            } else { currentProjectData.progress = 0; }
            updateOverallProgressBar(currentProjectData.progress);
        }
        
        function getProgressBarColor(progress) {
            const p = Number(progress) || 0;
            if (p >= 100) return 'bg-green-600';
            if (p >= 50) return 'bg-blue-500'; 
            return 'bg-yellow-500';
        }

        function updateOverallProgressBar(progress) {
            const progressBarEl = document.getElementById('overallProgressBar');
            const progressTextEl = document.getElementById('overallProgressText');
            if (progressBarEl && progressTextEl) {
                const p = Math.max(0, Math.min(100, Number(progress) || 0));
                progressBarEl.style.width = `${p}%`;
                progressBarEl.className = `h-full rounded-full text-xs font-medium text-white text-center p-0.5 leading-none transition-all duration-300 ${getProgressBarColor(p)}`;
                progressTextEl.textContent = `${p}%`;
            }
        }

        function renderList(containerElementId, items, listName, itemSingularName) {
            const containerElement = document.getElementById(containerElementId);
            if (!containerElement) { console.error(`Container ${containerElementId} not found.`); return; }
            containerElement.innerHTML = ''; 

            if (items && items.length > 0) {
                items.forEach(item => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card p-4 bg-white rounded-lg shadow-lg text-sm space-y-3'; 
                    
                    const descriptionDiv = document.createElement('div');
                    descriptionDiv.innerHTML = `<label class="block text-xs font-medium text-gray-500 mb-0.5">Descrição</label>
                                                <p class="text-gray-700 font-semibold min-h-[20px]">${item.description || 'N/A'}</p>`;
                    cardDiv.appendChild(descriptionDiv);

                    const statusDiv = document.createElement('div');
                    statusDiv.innerHTML = `<label class="block text-xs font-medium text-gray-500 mb-0.5">Status</label>`;
                    const statusSelect = document.createElement('select');
                    statusSelect.className = 'input-field !text-xs !py-1 !px-1.5 w-full';
                    itemStatusOptions.forEach(opt => {
                        const option = document.createElement('option');
                        option.value = opt; option.textContent = opt;
                        if (opt === item.status) option.selected = true;
                        statusSelect.appendChild(option);
                    });
                    statusSelect.onchange = (e) => updateListItemField(listName, item.id, 'status', e.target.value);
                    statusDiv.appendChild(statusSelect);
                    cardDiv.appendChild(statusDiv);

                    const percentageDiv = document.createElement('div');
                    percentageDiv.className = 'grid grid-cols-2 gap-2';
                    percentageDiv.innerHTML = `
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-0.5">Previsto (%)</label>
                            <input type="number" min="0" max="100" value="${item.plannedPercentage || 0}" class="input-field !text-xs !py-1 !px-1.5 w-full item-planned">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-0.5">Realizado (%)</label>
                            <input type="number" min="0" max="100" value="${item.actualPercentage || 0}" class="input-field !text-xs !py-1 !px-1.5 w-full item-actual">
                        </div>`;
                    percentageDiv.querySelector('.item-planned').onchange = (e) => updateListItemField(listName, item.id, 'plannedPercentage', parseInt(e.target.value) || 0);
                    percentageDiv.querySelector('.item-actual').onchange = (e) => updateListItemField(listName, item.id, 'actualPercentage', parseInt(e.target.value) || 0);
                    cardDiv.appendChild(percentageDiv);
                    
                    const endDateDiv = document.createElement('div');
                    endDateDiv.innerHTML = `<label class="block text-xs font-medium text-gray-500 mb-0.5">Data Final</label>
                                            <input type="date" value="${item.endDate || ''}" class="input-field !text-xs !py-1 !px-1.5 w-full item-end-date">`;
                    endDateDiv.querySelector('.item-end-date').onchange = (e) => updateListItemField(listName, item.id, 'endDate', e.target.value);
                    cardDiv.appendChild(endDateDiv);

                    const trafficLightSectionDiv = document.createElement('div');
                    trafficLightSectionDiv.innerHTML = `<label class="block text-xs font-medium text-gray-500 mb-1">Farol</label>`;
                    const farolControlsContainer = document.createElement('div');
                    farolControlsContainer.className = 'flex items-center space-x-2';

                    const farolDisplay = document.createElement('div');
                    const currentLightColorValue = item.trafficLight || "none";
                    let displayColorClass = 'bg-gray-300'; 
                    if (currentLightColorValue === 'green') displayColorClass = 'bg-green-500';
                    else if (currentLightColorValue === 'yellow') displayColorClass = 'bg-yellow-400';
                    else if (currentLightColorValue === 'red') displayColorClass = 'bg-red-500';
                    farolDisplay.className = `w-5 h-5 rounded-full traffic-light-display ${displayColorClass}`;
                    
                    const farolSelect = document.createElement('select');
                    farolSelect.className = 'input-field !text-xs !py-1 !px-1.5 w-auto flex-grow';
                    for (const colorValue in trafficLightColorOptions) {
                        const option = document.createElement('option');
                        option.value = colorValue;
                        option.textContent = trafficLightColorOptions[colorValue]; 
                        if (colorValue === currentLightColorValue) option.selected = true;
                        farolSelect.appendChild(option);
                    }
                    farolSelect.onchange = (e) => {
                        const newColorValue = e.target.value;
                        updateListItemField(listName, item.id, 'trafficLight', newColorValue);
                        let newDisplayColorClass = 'bg-gray-300';
                        if (newColorValue === 'green') newDisplayColorClass = 'bg-green-500';
                        else if (newColorValue === 'yellow') newDisplayColorClass = 'bg-yellow-400';
                        else if (newColorValue === 'red') newDisplayColorClass = 'bg-red-500';
                        farolDisplay.className = `w-5 h-5 rounded-full traffic-light-display ${newDisplayColorClass}`;
                    };
                    farolControlsContainer.appendChild(farolDisplay);
                    farolControlsContainer.appendChild(farolSelect);
                    trafficLightSectionDiv.appendChild(farolControlsContainer);
                    cardDiv.appendChild(trafficLightSectionDiv);


                    const deviationDiv = document.createElement('div');
                    deviationDiv.innerHTML = `<label class="block text-xs font-medium text-gray-500 mb-0.5">Justificativa Desvio</label>
                                             <textarea rows="2" class="input-field !text-xs !py-1 !px-1.5 w-full item-deviation" placeholder="Motivo do desvio...">${item.deviationReason || ''}</textarea>`;
                    deviationDiv.querySelector('.item-deviation').onblur = (e) => updateListItemField(listName, item.id, 'deviationReason', e.target.value);
                    cardDiv.appendChild(deviationDiv);

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = `<i class="fas fa-times text-red-500 hover:text-red-700"></i> Remover`;
                    removeBtn.className = 'text-xs text-red-600 hover:text-red-800 font-medium mt-2 p-1 self-end'; 
                    removeBtn.onclick = () => removeItemFromList(listName, item.id);
                    cardDiv.appendChild(removeBtn);

                    containerElement.appendChild(cardDiv);
                });
            } else {
                 containerElement.innerHTML = `<p class="text-sm text-gray-500 p-4 italic md:col-span-2 lg:col-span-3 text-center">Nenhum ${itemSingularName.toLowerCase()} adicionado.</p>`;
            }
        }

        function renderDetailedSchedule(tasks) {
            const tableBody = document.getElementById('detailedScheduleTableBody');
            if (!tableBody) { console.error("Table body 'detailedScheduleTableBody' not found."); return; }
            tableBody.innerHTML = ''; 

            if (!tasks || tasks.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="11" class="text-center p-4 text-gray-500 italic">Nenhuma tarefa no cronograma.</td></tr>';
                return;
            }

            tasks.forEach(task => {
                const row = tableBody.insertRow();
                row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';

                const createEditableCell = (value, type, field, options = []) => {
                    const cell = row.insertCell();
                    cell.className = 'p-2 text-xs align-middle';
                    let input;
                    if (type === 'select') {
                        input = document.createElement('select');
                        input.className = 'input-field !text-xs !py-1 !px-1.5 w-full';
                        options.forEach(opt => {
                            const option = document.createElement('option');
                            option.value = opt; option.textContent = opt;
                            if (opt === value) option.selected = true;
                            input.appendChild(option);
                        });
                    } else if (type === 'textarea') {
                        input = document.createElement('textarea');
                        input.className = 'input-field !text-xs !py-1 !px-1.5 w-full h-16 resize-none';
                        input.value = value;
                    } else if (type === 'progress') {
                        const progressContainer = document.createElement('div');
                        progressContainer.className = 'w-full';
                        const numberInput = document.createElement('input');
                        numberInput.type = 'number'; numberInput.min = "0"; numberInput.max = "100";
                        numberInput.value = value;
                        numberInput.className = 'input-field !text-xs !py-1 !px-1.5 w-16 mb-0.5 text-center';
                        numberInput.dataset.field = field; 
                        const progressBarOuter = document.createElement('div');
                        progressBarOuter.className = 'w-full bg-gray-200 rounded-full h-2.5';
                        const progressBarInner = document.createElement('div');
                        progressBarInner.className = `h-2.5 rounded-full transition-all duration-300 ${getProgressBarColor(value)}`; 
                        progressBarInner.style.width = `${value}%`;
                        progressBarOuter.appendChild(progressBarInner);
                        progressContainer.appendChild(numberInput);
                        progressContainer.appendChild(progressBarOuter);
                        cell.appendChild(progressContainer);
                        input = numberInput; 
                    } else {
                        input = document.createElement('input');
                        input.type = type;
                        input.className = 'input-field !text-xs !py-1 !px-1.5 w-full';
                        input.value = value;
                         if (type === 'date' && !value) { input.value = new Date().toISOString().split('T')[0];}
                    }
                    if (type !== 'progress') { cell.appendChild(input); }
                    input.addEventListener('change', (e) => {
                         let val = e.target.value;
                         if (type === 'number' || type === 'progress') {
                            val = parseInt(val) || 0; val = Math.max(0, Math.min(100, val)); 
                            if (type === 'progress') { 
                                const innerBar = e.target.closest('div').querySelector('div > div'); 
                                if(innerBar) {
                                    innerBar.style.width = `${val}%`;
                                    innerBar.className = `h-2.5 rounded-full transition-all duration-300 ${getProgressBarColor(val)}`;
                                }
                            }
                         }
                         updateTaskInSchedule(task.id, field, val);
                    });
                    input.addEventListener('blur', (e) => { 
                        if (type === 'text' || type === 'textarea' || type === 'date') {
                             updateTaskInSchedule(task.id, field, e.target.value);
                        }
                    });
                    return cell;
                };
                row.appendChild(createEditableCell(task.processo || '', 'text', 'processo'));
                row.appendChild(createEditableCell(task.squad || '', 'text', 'squad'));
                row.appendChild(createEditableCell(task.activity || 'Não iniciada', 'select', 'activity', activityOptions));
                row.appendChild(createEditableCell(task.startDate || '', 'date', 'startDate'));
                row.appendChild(createEditableCell(task.endDate || '', 'date', 'endDate'));
                row.appendChild(createEditableCell(task.duration || 0, 'number', 'duration'));
                const responsibleText = `P:${task.productLead||''};E:${task.deliveryLead||''};T:${task.technicalLead||''}`;
                row.appendChild(createEditableCell(responsibleText, 'textarea', 'responsibles'));
                row.appendChild(createEditableCell(task.criticality || 'Média', 'select', 'criticality', taskCriticalityOptions));
                row.appendChild(createEditableCell(task.status || 'Não Iniciado', 'select', 'status', taskStatusOptions));
                row.appendChild(createEditableCell(task.progress || 0, 'progress', 'progress'));
                
                const actionsCell = row.insertCell();
                actionsCell.className = 'p-2 text-xs align-middle text-center space-x-1';
                
                const geminiBtn = document.createElement('button');
                geminiBtn.innerHTML = '<i class="fas fa-magic text-purple-600"></i>';
                geminiBtn.className = 'p-1 hover:bg-purple-100 rounded-full';
                geminiBtn.title = "✨ Detalhar Tarefa com IA";
                geminiBtn.onclick = () => detailTaskWithAI(task);
                actionsCell.appendChild(geminiBtn);

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash-alt text-red-500 hover:text-red-700"></i>';
                deleteBtn.className = 'p-1'; deleteBtn.title = "Excluir Tarefa";
                deleteBtn.onclick = () => removeTaskFromSchedule(task.id);
                actionsCell.appendChild(deleteBtn);
            });
        }

        function renderTimeline(tasks) {
            const timelineContainer = document.getElementById('milestonesTimeline');
            if (!timelineContainer) { console.error("Timeline container not found."); return; }
            timelineContainer.innerHTML = ''; // Clear previous milestones

            const completedTasks = tasks.filter(task => task.status === 'Concluído' && task.endDate)
                                        .sort((a,b) => new Date(a.endDate) - new Date(b.endDate)); // Sort by end date

            if (completedTasks.length === 0) {
                timelineContainer.innerHTML = '<p class="text-sm text-gray-500 italic">Nenhum marco concluído para exibir na linha do tempo.</p>';
                return;
            }

            completedTasks.forEach((task, index) => {
                const milestoneElement = document.createElement('div');
                milestoneElement.className = 'relative pl-8 sm:pl-32 py-3 group';

                // Line
                if (index < completedTasks.length -1) { // No line after the last item
                     milestoneElement.innerHTML += `<div class="flex flex-col sm:flex-row items-start mb-1 group-last:hidden">
                                                    <div class="absolute left-2 sm:left-0 h-full w-0.5 bg-orange-300 self-stretch group-last:hidden"></div>
                                                 </div>`;
                }
                // Dot
                milestoneElement.innerHTML += `<div class="absolute left-2 sm:left-0 transform -translate-x-1/2 mt-0.5">
                                                <div class="w-4 h-4 bg-orange-500 rounded-full border-2 border-white"></div>
                                              </div>`;
                // Content
                const contentDiv = document.createElement('div');
                contentDiv.className = 'bg-white p-3 rounded-lg shadow-md hover:shadow-xl transition-shadow';
                const endDateFormatted = task.endDate ? new Date(task.endDate).toLocaleDateString('pt-BR') : 'Data não definida';
                contentDiv.innerHTML = `
                    <h4 class="text-sm font-semibold text-orange-600">${endDateFormatted}</h4>
                    <p class="text-xs text-gray-700">${task.processo || 'Marco'}: ${task.activity || 'Concluído'}</p>
                `;
                milestoneElement.appendChild(contentDiv);
                timelineContainer.appendChild(milestoneElement);
            });
        }
        
        function attachActionListeners() {
            const projectTitleHeaderEl = document.getElementById('projectTitleHeader');
            if (projectTitleHeaderEl) projectTitleHeaderEl.onblur = (e) => saveProjectDataField('projectName', e.target.textContent);

            const projectResponsiblesEl = document.getElementById('projectResponsibles');
            if(projectResponsiblesEl) projectResponsiblesEl.onblur = (e) => saveProjectDataField('projectResponsibles', e.target.textContent);
            
            const projectDepartmentEl = document.getElementById('projectDepartment');
            if(projectDepartmentEl) projectDepartmentEl.onblur = (e) => saveProjectDataField('projectDepartment', e.target.textContent);

            const projectTermEl = document.getElementById('projectTerm');
            if(projectTermEl) projectTermEl.onblur = (e) => saveProjectDataField('projectTerm', e.target.textContent);
            
            const currentPhaseEl = document.getElementById('currentPhase');
            if(currentPhaseEl) currentPhaseEl.onblur = (e) => saveProjectDataField('currentPhase', e.target.textContent);
            
            const nextMilestoneEl = document.getElementById('nextMilestoneText');
            if(nextMilestoneEl) nextMilestoneEl.onblur = (e) => saveProjectDataField('nextMilestoneText', e.target.textContent);


            const projectObjectiveEl = document.getElementById('projectObjectiveTextarea');
            if (projectObjectiveEl) projectObjectiveEl.onblur = (e) => saveProjectDataField('objective', e.target.value);
            
            const mainImpactsRisksEl = document.getElementById('mainImpactsAndRisksContent');
            if (mainImpactsRisksEl) mainImpactsRisksEl.onblur = (e) => saveProjectDataField('mainImpactsAndRisksHTML', e.target.innerHTML);

            const projectDetailsEl = document.getElementById('projectDetailsContent');
            if (projectDetailsEl) projectDetailsEl.onblur = (e) => saveProjectDataField('projectDetailsHTML', e.target.innerHTML);

            const addRiskBtn = document.getElementById('addRiskButton');
            const newRiskInput = document.getElementById('newRiskInput'); 
            if (addRiskBtn && newRiskInput) addRiskBtn.onclick = () => { addItemToList('risks', newRiskInput.value); newRiskInput.value = ''; };

            const addProblemBtn = document.getElementById('addProblemButton');
            const newProblemInput = document.getElementById('newProblemInput'); 
            if (addProblemBtn && newProblemInput) addProblemBtn.onclick = () => { addItemToList('problems', newProblemInput.value); newProblemInput.value = ''; };

            const addImpactBtn = document.getElementById('addImpactButton');
            const newImpactInput = document.getElementById('newImpactInput'); 
            if (addImpactBtn && newImpactInput) addImpactBtn.onclick = () => { addItemToList('impacts', newImpactInput.value); newImpactInput.value = ''; };

            const suggestRiskBtn = document.getElementById('suggestRiskButton');
            if(suggestRiskBtn) suggestRiskBtn.onclick = () => suggestItemsWithAI('risks');
            const suggestProblemBtn = document.getElementById('suggestProblemButton');
            if(suggestProblemBtn) suggestProblemBtn.onclick = () => suggestItemsWithAI('problems');
            const suggestImpactBtn = document.getElementById('suggestImpactButton');
            if(suggestImpactBtn) suggestImpactBtn.onclick = () => suggestItemsWithAI('impacts');

            const addNewTaskBtnEl = document.getElementById('addNewTaskButton'); 
            if (addNewTaskBtnEl) {
                addNewTaskBtnEl.onclick = addNewTaskToSchedule;
            } else {
                console.warn("Button 'addNewTaskButton' not found during attachActionListeners.");
            }
            
            const deleteAllTasksBtnEl = document.getElementById('deleteAllTasksButton'); 
            if (deleteAllTasksBtnEl) deleteAllTasksBtnEl.onclick = deleteAllTasksFromSchedule;

            const analyzeDeadlinesBtnEl = document.getElementById('analyzeDeadlinesButton'); 
            if (analyzeDeadlinesBtnEl) analyzeDeadlinesBtnEl.onclick = analyzeDeadlinesWithAI; 

            const clearProjectBtn = document.getElementById('clearProjectButton');
            if(clearProjectBtn) clearProjectBtn.onclick = () => {
                if(confirm("Tem certeza que deseja limpar todos os dados do projeto atual (exceto o nome) e começar um novo? Esta ação não pode ser desfeita para o projeto atual.")) {
                    if(projectDocRef) {
                        const currentName = currentProjectData.projectName; 
                        const clearedData = { ...initialProjectData, projectName: currentName }; 
                        setDoc(projectDocRef, clearedData)
                            .then(() => displayMessage("Projeto limpo. Você pode começar a preencher os dados para um novo projeto.", "success"))
                            .catch(e => displayMessage("Erro ao limpar o projeto.", "error"));
                    }
                }
            };

            const geminiModalClose = document.getElementById('geminiModalCloseButton');
            if (geminiModalClose) geminiModalClose.onclick = closeGeminiResponseModal;
        }

        function openGeminiResponseModal(title, content, isLoading = false) { /* ... (same as before) ... */ }
        function closeGeminiResponseModal() { /* ... (same as before) ... */ }
        function displayMessage(message, type = "info") { /* ... (same as before) ... */ }

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .header-bg { background-color: #003352; /* SulAmerica Dark Blue */ }
        .header-info-box { background-color: rgba(255,255,255,0.1); backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.2); }
        .section-title { color: #003352; }
        .card { background-color: white; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); }
        
        th.schedule-header { background-color: #e0eef5; color: #003352; padding: 0.75rem 0.5rem; font-size: 0.75rem; white-space: nowrap; text-align: left; }
        td .input-field, td .input-field select { font-size: 0.75rem !important; padding: 0.25rem 0.5rem !important; border-radius: 0.25rem; }
        td textarea.input-field { min-height: 4rem; font-size: 0.75rem !important; padding: 0.25rem 0.5rem !important; border-radius: 0.25rem;}
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 10px; }
        .table-container::-webkit-scrollbar-thumb { background: #005587; border-radius: 10px; }
        
        .input-field, textarea.input-field, div[contenteditable="true"] { 
            border: 1px solid #D1D5DB; padding: 0.625rem 0.875rem; border-radius: 0.5rem; width: 100%; font-size: 0.875rem;
        }
        .input-field:focus, textarea.input-field:focus, div[contenteditable="true"]:focus {
            outline: none; border-color: #FF8C00; box-shadow: 0 0 0 3px rgba(255,140,0,0.3);
        }
        div[contenteditable="true"] { min-height: 40px; background-color: #f9fafb; padding: 0.5rem; } 
        h1[contenteditable="true"]:focus { background-color: rgba(255,255,255,0.1) !important; }


        .btn-sulamerica-orange { background-color: #FF8C00; color: white; }
        .btn-sulamerica-orange:hover { background-color: #E67E00; }
        
        .btn-sulamerica-red { background-color: #EF4444; color: white; } 
        .btn-sulamerica-red:hover { background-color: #DC2626; }

        .btn-sulamerica-indigo { background-color: #6366F1; color: white; } 
        .btn-sulamerica-indigo:hover { background-color: #4F46E5; }

        .btn-sulamerica-green { background-color: #10B981; color: white; } 
        .btn-sulamerica-green:hover { background-color: #059669; }
        
        .btn-sulamerica-cyan { background-color: #06B6D4; color: white; } 
        .btn-sulamerica-cyan:hover { background-color: #0891B2; }
        
        .btn-gemini-suggest { background-color: #8B5CF6; color:white; } 
        .btn-gemini-suggest:hover { background-color: #7C3AED; }


        #messageContainer { position: fixed; top: 100px; right: 20px; z-index: 1050; width: 320px; display: flex; flex-direction: column; gap: 10px; }
        #messageContainer div { transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out; opacity: 1; transform: translateX(0); }
        #messageContainer div[style*="opacity: 0"] { transform: translateX(100%); }
        .modal-overlay { background-color: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .modal-content { background-color: white; padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        
        .traffic-light-display { border: 1px solid #ccc; }
        .bg-green-500 { background-color: #22c55e; }
        .bg-yellow-400 { background-color: #facc15; } 
        .bg-yellow-500 { background-color: #eab308; } 
        .bg-blue-500 { background-color: #3b82f6; }   
        .bg-red-500 { background-color: #ef4444; }
        .bg-gray-300 { background-color: #d1d5db; } 
    </style>
</head>
<body class="text-gray-800">
    <header class="header-bg text-white p-6 shadow-lg sticky top-0 z-40">
         <div class="container mx-auto">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center">
                    <svg class="w-10 h-10 mr-3" viewBox="0 0 50 50" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M25 0C11.19 0 0 11.19 0 25C0 38.81 11.19 50 25 50C38.81 50 50 38.81 50 25C50 11.19 38.81 0 25 0ZM25 44C14.52 44 6 35.48 6 25C6 14.52 14.52 6 25 6C35.48 6 44 14.52 44 25C44 35.48 35.48 44 25 44Z" fill="#FF8C00"/><path d="M25 8.8C16.08 8.8 8.8 16.08 8.8 25C8.8 33.92 16.08 41.2 25 41.2C33.92 41.2 41.2 33.92 41.2 25C41.2 16.08 33.92 8.8 25 8.8ZM25 35C19.49 35 15 30.51 15 25C15 19.49 19.49 15 25 15C30.51 15 35 19.49 35 25C35 30.51 30.51 35 25 35Z" fill="#005587"/></svg>
                    <h1 id="projectTitleHeader" contenteditable="true" class="text-3xl font-bold outline-none focus:ring-1 focus:ring-white focus:bg-gray-700/50 px-2 rounded-md">Carregando Nome...</h1>
                </div>
                <div class="text-right">
                    <button id="clearProjectButton" class="text-xs bg-yellow-500 hover:bg-yellow-600 text-white py-1.5 px-3 rounded-md shadow-md flex items-center">
                        <i class="fas fa-file-alt mr-1.5"></i>Limpar Projeto
                    </button>
                    <p class="text-xs mt-1 opacity-80">Data de Atualização: <span id="lastUpdatedDate"></span></p>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
                <div class="header-info-box p-3 rounded-lg">
                    <h2 class="text-sm font-semibold opacity-80 mb-1">Responsáveis</h2>
                    <p id="projectResponsibles" contenteditable="true" class="text-xs outline-none focus:ring-1 focus:ring-white focus:bg-gray-700/30 p-1 rounded-sm min-h-[20px]">Carregando...</p>
                </div>
                <div class="header-info-box p-3 rounded-lg">
                    <h2 class="text-sm font-semibold opacity-80 mb-1">Departamento</h2>
                    <p id="projectDepartment" contenteditable="true" class="text-xs outline-none focus:ring-1 focus:ring-white focus:bg-gray-700/30 p-1 rounded-sm min-h-[20px]">Carregando...</p>
                </div>
                <div class="header-info-box p-3 rounded-lg">
                    <h2 class="text-sm font-semibold opacity-80 mb-1">Prazo</h2>
                    <p id="projectTerm" contenteditable="true" class="text-xs outline-none focus:ring-1 focus:ring-white focus:bg-gray-700/30 p-1 rounded-sm min-h-[20px]">Carregando...</p>
                </div>
            </div>
        </div>
    </header>

    <div id="messageContainer"></div>

    <div id="geminiResponseModal" class="fixed inset-0 modal-overlay hidden z-50 p-4">
        <div class="modal-content w-full max-w-2xl max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center pb-3 border-b mb-4">
                <h3 id="geminiModalTitle" class="text-xl font-semibold section-title">Sugestões da IA</h3>
                <button id="geminiModalCloseButton" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="geminiLoadingIndicator" class="hidden items-center justify-center py-10">
                <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-blue-600"></div>
                <p class="ml-4 text-lg">Consultando IA...</p>
            </div>
            <div id="geminiModalContent" class="text-sm text-gray-700 leading-relaxed overflow-y-auto prose prose-sm max-w-none">
                {/* Content from Gemini API will be injected here */}
            </div>
        </div>
    </div>


    <main class="container mx-auto p-4 md:p-6">
        <section id="project-progress-section" class="mb-8 card p-6">
            <h2 class="text-xl font-semibold mb-3 section-title"><i class="fas fa-tasks mr-2"></i>Progresso do Projeto</h2>
            <div class="mb-4">
                <div class="flex justify-between text-sm mb-1">
                    <span>Progresso Geral</span>
                    <span id="overallProgressText" class="font-semibold text-orange-500">0%</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-5 overflow-hidden">
                    <div id="overallProgressBar" class="h-full rounded-full text-xs font-medium text-white text-center p-0.5 leading-none transition-all duration-300" style="width: 0%;">
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div>
                    <h4 class="font-medium text-gray-600 mb-1">Fase Atual</h4>
                    <p id="currentPhase" contenteditable="true" class="input-field !text-sm !py-1.5">Carregando...</p>
                </div>
                <div>
                    <h4 class="font-medium text-gray-600 mb-1">Próximo Marco</h4>
                    <p id="nextMilestoneText" contenteditable="true" class="input-field !text-sm !py-1.5">Carregando...</p>
                </div>
            </div>
        </section>

        <section id="milestones-timeline-section" class="mb-8 card p-6">
            <h2 class="text-xl font-semibold mb-4 section-title"><i class="fas fa-stream mr-2"></i>Linha do Tempo dos Marcos</h2>
            <div id="milestonesTimeline" class="relative">
                {/* Milestones will be rendered here */}
            </div>
        </section>
        
        <section id="executive-summary" class="mb-8">
            <h2 class="text-2xl font-semibold mb-4 section-title">Resumo Executivo</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="card p-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Objetivo do Projeto</h3>
                    <textarea id="projectObjectiveTextarea" rows="5" class="input-field text-sm text-gray-600" placeholder="Descreva o objetivo..."></textarea>
                </div>
                <div class="card p-6">
                    <h3 class="text-lg font-medium text-gray-700 mb-2">Principais Impactos e Riscos</h3>
                    <div id="mainImpactsAndRisksContent" contenteditable="true" class="input-field text-sm text-gray-600 prose prose-sm max-w-none">
                        {/* Content will be loaded here by JS */}
                    </div>
                </div>
            </div>
        </section>

        <section id="project-details-section" class="mb-8 card p-6">
             <h2 class="text-2xl font-semibold mb-4 section-title">Detalhes do Projeto</h2>
             <div id="projectDetailsContent" contenteditable="true" class="input-field text-sm text-gray-600 prose prose-sm max-w-none">
                {/* Content will be loaded here by JS */}
             </div>
        </section>

        <section id="detailed-schedule-section" class="mb-8"> 
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-semibold section-title">Cronograma Detalhado Interativo</h2>
                <div class="flex items-center space-x-2">
                    <button id="addNewTaskButton" class="btn-sulamerica-green text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Adicionar Tarefa
                    </button>
                    <button id="deleteAllTasksButton" class="btn-sulamerica-red !bg-red-600 hover:!bg-red-700 text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-trash-alt mr-2"></i>Excluir Todas
                    </button>
                    <button id="analyzeDeadlinesButton" class="btn-sulamerica-cyan text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                       <i class="fas fa-brain mr-2"></i> ✨ Analisar Prazos com IA
                    </button>
                </div>
            </div>
            <div class="card p-0 overflow-hidden">
                <div class="table-container">
                    <table class="min-w-full">
                        <thead class="border-b border-gray-300">
                            <tr>
                                <th class="schedule-header">Processo</th> 
                                <th class="schedule-header">Squad</th> 
                                <th class="schedule-header w-1/6">Atividade Principal</th>
                                <th class="schedule-header">Início</th>
                                <th class="schedule-header">Fim</th>
                                <th class="schedule-header">Duração (d)</th>
                                <th class="schedule-header w-1/6">Responsáveis (P;E;T)</th>
                                <th class="schedule-header">Criticidade</th>
                                <th class="schedule-header">Status</th>
                                <th class="schedule-header">%</th>
                                <th class="schedule-header">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="detailedScheduleTableBody">
                            <tr><td colspan="11" class="text-center p-5 text-gray-500 italic">Carregando cronograma...</td></tr> 
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <div id="confirmationModal" class="fixed inset-0 modal-overlay hidden z-50">
            <div class="modal-content w-full max-w-md">
                <h3 class="text-lg font-medium text-gray-900 mb-2 section-title">Confirmar Exclusão</h3>
                <p id="confirmationModalText" class="text-sm text-gray-600 mb-4">Tem certeza?</p>
                <div class="flex justify-end space-x-3">
                    <button id="cancelDeleteAllTasksBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 py-2 px-4 rounded-md">Cancelar</button>
                    <button id="confirmDeleteAllTasksBtn" class="btn-sulamerica-red !bg-red-600 hover:!bg-red-700 py-2 px-4 rounded-md">Excluir</button>
                </div>
            </div>
        </div>

        <section id="project-risks-section" class="mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-y-2">
                <h2 class="text-2xl font-semibold section-title">Riscos do Projeto</h2>
                <div class="flex items-center gap-2">
                    <input type="text" id="newRiskInput" class="input-field flex-grow max-w-xs text-sm" placeholder="Nova descrição do risco">
                    <button id="addRiskButton" class="btn-sulamerica-orange text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Adicionar Risco
                    </button>
                    <button id="suggestRiskButton" class="btn-gemini-suggest text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i>✨ Sugerir
                    </button>
                </div>
            </div>
            <div id="risksContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* Risk items rendered here */}
            </div>
        </section>

        <section id="project-problems-section" class="mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-y-2">
                <h2 class="text-2xl font-semibold section-title">Problemas Identificados</h2>
                 <div class="flex items-center gap-2">
                    <input type="text" id="newProblemInput" class="input-field flex-grow max-w-xs text-sm" placeholder="Nova descrição do problema">
                    <button id="addProblemButton" class="btn-sulamerica-red text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Adicionar Problema
                    </button>
                     <button id="suggestProblemButton" class="btn-gemini-suggest text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i>✨ Sugerir
                    </button>
                </div>
            </div>
            <div id="problemsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* Problem items rendered here */}
            </div>
        </section>

        <section id="project-impacts-section" class="mb-8">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-y-2">
                <h2 class="text-2xl font-semibold section-title">Impactos Esperados</h2>
                 <div class="flex items-center gap-2">
                    <input type="text" id="newImpactInput" class="input-field flex-grow max-w-xs text-sm" placeholder="Nova descrição do impacto">
                    <button id="addImpactButton" class="btn-sulamerica-indigo text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-plus mr-2"></i>Adicionar Impacto
                    </button>
                     <button id="suggestImpactButton" class="btn-gemini-suggest text-sm py-2 px-3 rounded-md shadow transition-colors flex items-center">
                        <i class="fas fa-lightbulb mr-2"></i>✨ Sugerir
                    </button>
                </div>
            </div>
            <div id="impactsContainer" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {/* Impact items rendered here */}
            </div>
        </section>

        <footer class="text-center p-4 text-sm text-gray-500 border-t mt-10">
            Painel de Controle do Projeto - SulAmérica &copy; <span id="currentYear"></span>
            <p class="text-xs text-gray-400 mt-1">ID do Usuário: <span id="userIdDisplay" class="font-mono">Carregando...</span></p>
        </footer>
    </main>
</body>
</html>
